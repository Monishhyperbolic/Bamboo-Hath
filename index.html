<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compound Collateral Health Monitor</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
  <!-- ethers.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* Additional Tailwind styles */
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">
  <!-- Header -->
  <header class="bg-blue-600 text-white py-4 shadow-md">
    <h1 class="text-2xl font-bold text-center">Compound Health Monitor (Sepolia)</h1>
  </header>
  <!-- Main Content -->
  <main class="flex-grow p-4 max-w-4xl mx-auto w-full">
    <!-- Wallet Connection -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-6">
      <button id="connectWallet" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition duration-300">
        Connect Wallet
      </button>
      <div id="walletInfo" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
        <p class="text-sm font-medium">Wallet: <span id="walletAddress" class="font-mono text-xs break-all"></span></p>
        <p class="text-sm font-medium mt-2">Health Factor: <span id="healthFactor" class="font-bold text-green-600">N/A</span></p>
        <p class="text-sm font-medium mt-2">Collateral Value: <span id="collateralValue" class="font-bold">N/A</span></p>
        <p class="text-sm font-medium mt-2">Borrowed Value: <span id="borrowValue" class="font-bold">N/A</span></p>
      </div>
      <p id="errorMessage" class="hidden text-red-500 text-sm mt-2"></p>
    </section>
    <!-- Health Trend Chart -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-lg font-semibold mb-4">Health Factor Trend</h2>
      <canvas id="healthChart"></canvas>
    </section>
    <!-- Settings Form -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-lg font-semibold mb-4">Notification Settings</h2>
      <form id="settingsForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Alert Threshold (Health Factor)</label>
          <input type="number" step="0.1" value="1.1" id="threshold" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <p class="text-xs text-gray-500 mt-1">Notify when health factor falls below this value (e.g., 1.1).</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Notification Email</label>
          <input type="email" id="email" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@email.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Phone Number (for SMS)</label>
          <input type="tel" id="phone" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+12345678900">
          <p class="text-xs text-gray-500 mt-1">Enter phone number in international format (e.g., +12345678900).</p>
        </div>
        <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition duration-300">
          Start Monitoring
        </button>
      </form>
    </section>
    <!-- Notification History -->
    <section class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold mb-4">Notification History</h2>
      <ul id="notificationHistory" class="space-y-2">
        <li class="text-sm text-gray-500 p-2 bg-gray-50 rounded">No notifications yet. Connect your wallet and start monitoring.</li>
      </ul>
    </section>
  </main>
  <script>
    // Sepolia network configuration
    const SEPOLIA_CHAIN_ID = "0xaa36a7";
    const SEPOLIA_CONFIG = {
      chainId: SEPOLIA_CHAIN_ID,
      chainName: "Sepolia",
      nativeCurrency: { name: "Sepolia ETH", symbol: "ETH", decimals: 18 },
      rpcUrls: ["https://sepolia.infura.io/v3/"],
      blockExplorerUrls: ["https://sepolia.etherscan.io/"]
    };

    // Compound V2 Sepolia contract addresses
    const COMPOUND_ADDRESSES = {
      comptroller: "0x3d9819210A31b4961b30EF54bE2aeD79B9c9Cd3B", // Example address
      cTokens: {
        cETH: "0x4Ddc2D193948926D02f9B1fE9e1daa0718270ED5",
        cDAI: "0x5d3a536E4D6DbD6114cc1Ead35777bAB948E3643"
      }
    };

    let provider;
    let signer;
    let monitoringInterval;

    async function initializeWeb3() {
      if (!window.ethereum) {
        showError("MetaMask is not installed. Please install MetaMask and try again.");
        return false;
      }

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        console.log("Provider initialized:", provider);

        // Check current network
        const network = await provider.getNetwork();
        console.log("Current chain ID:", network.chainId);

        if (network.chainId !== parseInt(SEPOLIA_CHAIN_ID, 16)) {
          console.log("Attempting to switch to Sepolia...");
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: SEPOLIA_CHAIN_ID }],
            });
            console.log("Switched to Sepolia.");
          } catch (switchError) {
            if (switchError.code === 4902) {
              console.log("Sepolia not found in MetaMask. Adding network...");
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [SEPOLIA_CONFIG],
              });
              console.log("Sepolia added.");
            } else {
              throw switchError;
            }
          }
        } else {
          console.log("Already on Sepolia network.");
        }

        return true;
      } catch (error) {
        console.error("Error initializing Web3:", error);
        showError(`Failed to initialize Web3: ${error.message}`);
        return false;
      }
    }

    // Chart.js setup
    let healthChart;
    const healthData = { 
      labels: [], 
      datasets: [{ 
        label: "Health Factor", 
        data: [], 
        borderColor: "rgb(75, 192, 192)", 
        backgroundColor: "rgba(75, 192, 192, 0.1)",
        tension: 0.1,
        fill: true
      }] 
    };

    function initChart() {
      const ctx = document.getElementById("healthChart").getContext("2d");
      healthChart = new Chart(ctx, {
        type: "line",
        data: healthData,
        options: { 
          responsive: true,
          scales: { 
            y: { 
              beginAtZero: false,
              title: {
                display: true,
                text: 'Health Factor'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Time'
              }
            }
          },
          plugins: {
            legend: {
              display: true
            },
            title: {
              display: true,
              text: 'Health Factor Over Time'
            }
          }
        }
      });
    }

    // NotificationAPI configuration
    const NOTIFICATION_API_CONFIG = {
      clientId: 'a4lsubuvif0i11gsbtlgdtseby',
      clientSecret: 'uf3fq44h7ewonz64mnte4ugfedrgwcnix435qf7zxir5qaapumzwdr4xyj'
    };

    // Send notification via NotificationAPI
    async function sendNotification(email, phone, message, healthFactor, threshold) {
      try {
        // In a real application, this would be sent to your backend
        // For demo purposes, we'll simulate the API call
        const notificationData = {
          type: 'alert',
          to: {
            email: email || 'patilmonish89@gmail.com',
            number: phone || '+15005550006'
          },
          parameters: {
            healthFactor: healthFactor,
            threshold: threshold,
            message: message,
            timestamp: new Date().toISOString()
          }
        };

        // Simulate API call to backend that would use NotificationAPI
        console.log('Sending notification via NotificationAPI:', notificationData);
        
        // In production, this would be:
        // const response = await fetch('/api/send-notification', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify(notificationData)
        // });
        
        // For demo, we'll show success
        showNotification("Alert Sent", `Notification sent to ${email || 'default email'}`);
        return { success: true, data: notificationData };
        
      } catch (error) {
        console.error('Error sending notification:', error);
        return { success: false, error: error.message };
      }
    }
    function showError(message) {
      const errorElement = document.getElementById("errorMessage");
      errorElement.classList.remove("hidden");
      errorElement.textContent = message;
    }

    function hideError() {
      document.getElementById("errorMessage").classList.add("hidden");
    }

    function showNotification(title, message) {
      // Simple notification fallback
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification(title, { body: message });
      } else {
        alert(`${title}: ${message}`);
      }
    }

    // Connect to MetaMask
    async function connectWallet() {
      const initialized = await initializeWeb3();
      if (!initialized) return;

      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        signer = provider.getSigner();
        const address = await signer.getAddress();
        console.log("Connected wallet:", address);
        
        document.getElementById("walletAddress").textContent = address;
        document.getElementById("walletInfo").classList.remove("hidden");
        hideError();
        
        await updateDashboard(address);
        startMonitoring(address);
        
      } catch (error) {
        console.error("Error connecting wallet:", error);
        if (error.code === 4001) {
          showError("Connection rejected. Please approve the connection in MetaMask.");
        } else {
          showError(`Failed to connect wallet: ${error.message}`);
        }
      }
    }

    // Simulate health factor calculation (since we don't have actual Compound.js)
    function calculateHealthFactor() {
      // This is a simulation - in a real app, you'd query Compound contracts
      const baseHealth = 1.5;
      const variation = (Math.random() - 0.5) * 0.4; // Random variation
      return Math.max(0.8, baseHealth + variation);
    }

    // Update dashboard with health and balances
    async function updateDashboard(address) {
      try {
        // Simulate fetching data (replace with actual Compound contract calls)
        const healthFactor = calculateHealthFactor();
        const totalCollateral = 1000 + Math.random() * 500; // Simulated
        const totalBorrowed = 500 + Math.random() * 200; // Simulated
        
        document.getElementById("healthFactor").textContent = healthFactor.toFixed(2);
        
        // Color code health factor
        const healthElement = document.getElementById("healthFactor");
        if (healthFactor < 1.1) {
          healthElement.className = "font-bold text-red-600";
        } else if (healthFactor < 1.3) {
          healthElement.className = "font-bold text-yellow-600";
        } else {
          healthElement.className = "font-bold text-green-600";
        }

        // Update chart
        const now = new Date().toLocaleTimeString();
        healthData.labels.push(now);
        healthData.datasets[0].data.push(healthFactor);
        
        if (healthData.labels.length > 20) {
          healthData.labels.shift();
          healthData.datasets[0].data.shift();
        }
        healthChart.update();

        document.getElementById("collateralValue").textContent = `$${totalCollateral.toFixed(2)}`;
        document.getElementById("borrowValue").textContent = `$${totalBorrowed.toFixed(2)}`;
        
        // Check threshold
        await checkHealthThreshold(healthFactor, address);
        
      } catch (error) {
        console.error("Error updating dashboard:", error);
        document.getElementById("healthFactor").textContent = "Error";
        showError("Failed to fetch data. Please try again.");
      }
    }

    // Check health threshold and notify
    async function checkHealthThreshold(healthFactor, address) {
      const threshold = parseFloat(document.getElementById("threshold").value) || 1.1;
      
      if (healthFactor < threshold) {
        const message = `âš ï¸ HEALTH ALERT: Your health factor ${healthFactor.toFixed(2)} is below threshold ${threshold}. Consider adding collateral or reducing debt.`;
        const email = document.getElementById("email").value;
        const phone = document.getElementById("phone").value;
        
        // Send via NotificationAPI
        const result = await sendNotification(email, phone, message, healthFactor, threshold);
        
        if (result.success) {
          showNotification("Health Alert", message);
          addNotificationToHistory(message, 'alert');
        } else {
          addNotificationToHistory(`Failed to send alert: ${result.error}`, 'error');
        }
      }
    }

    // Add notification to history
    function addNotificationToHistory(message, type = 'info') {
      const historyList = document.getElementById("notificationHistory");
      
      // Clear placeholder if it exists
      if (historyList.children.length === 1 && historyList.children[0].textContent.includes("No notifications yet")) {
        historyList.innerHTML = "";
      }
      
      const li = document.createElement("li");
      
      // Style based on notification type
      let className = "text-sm p-3 rounded border-l-4 mb-2";
      let icon = "";
      
      switch(type) {
        case 'alert':
          className += " text-red-800 bg-red-50 border-red-400";
          icon = "ðŸš¨ ";
          break;
        case 'error':
          className += " text-red-700 bg-red-50 border-red-300";
          icon = "âŒ ";
          break;
        case 'success':
          className += " text-green-700 bg-green-50 border-green-400";
          icon = "âœ… ";
          break;
        default:
          className += " text-gray-700 bg-gray-50 border-gray-400";
          icon = "â„¹ï¸ ";
      }
      
      li.className = className;
      li.innerHTML = `
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <span class="font-medium">${icon}${new Date().toLocaleTimeString()}</span>
            <p class="mt-1">${message}</p>
          </div>
        </div>
      `;
      
      historyList.insertBefore(li, historyList.firstChild);
      
      // Keep only last 15 notifications
      while (historyList.children.length > 15) {
        historyList.removeChild(historyList.lastChild);
      }
    }

    // Start monitoring
    function startMonitoring(address) {
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
      }
      
      monitoringInterval = setInterval(() => {
        updateDashboard(address);
      }, 5000); // Update every 5 seconds
    }

    // Handle wallet connection
    document.getElementById("connectWallet").addEventListener("click", connectWallet);

    // Handle settings form
    document.getElementById("settingsForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const threshold = parseFloat(document.getElementById("threshold").value);
      const email = document.getElementById("email").value;
      const phone = document.getElementById("phone").value;
      const address = document.getElementById("walletAddress").textContent;

      if (!address) {
        showError("Please connect your wallet first!");
        return;
      }

      if (threshold <= 0) {
        showError("Please enter a valid threshold value.");
        return;
      }

      // In a real app, you would save these settings to a backend
      console.log("Settings saved:", { address, threshold, email, phone });
      
      // Test notification to confirm settings work
      await sendNotification(email, phone, 
        `âœ… Monitoring started for wallet ${address.substring(0, 6)}...${address.substring(-4)}. Threshold: ${threshold}`,
        null, threshold);
      
      addNotificationToHistory(`Monitoring started with threshold ${threshold}`, 'success');
      hideError();
      
      // Start monitoring with new threshold
      startMonitoring(address);
    });

    // Request notification permission
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }

    // Initialize chart on load
    document.addEventListener("DOMContentLoaded", function() {
      initChart();
    });

    // Handle account changes
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', function (accounts) {
        if (accounts.length === 0) {
          // User disconnected
          document.getElementById("walletInfo").classList.add("hidden");
          if (monitoringInterval) {
            clearInterval(monitoringInterval);
          }
        } else {
          // Account changed
          connectWallet();
        }
      });

      window.ethereum.on('chainChanged', function (chainId) {
        // Reload when chain changes
        window.location.reload();
      });
    }
  </script>
</body>
</html>