<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compound Collateral Health Monitor</title>
  <!-- Tailwind CSS CDN -->
  <script src="[invalid url, do not cite]
  <!-- ethers.js CDN -->
  <script src="[invalid url, do not cite]
  <!-- Compound.js CDN -->
  <script type="text/javascript" src="[invalid url, do not cite]" defer></script>
  <!-- push.js CDN -->
  <script src="[invalid url, do not cite]
  <!-- Chart.js CDN -->
  <script src="[invalid url, do not cite]
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-sans">
  <!-- Header -->
  <header class="bg-blue-600 text-white py-4 shadow-md">
    <h1 class="text-2xl font-bold text-center">Compound Health Monitor (Sepolia)</h1>
  </header>
  <!-- Main Content -->
  <main class="flex-grow p-4 max-w-4xl mx-auto w-full">
    <!-- Wallet Connection -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-6">
      <button id="connectWallet" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition duration-300">
        Connect Wallet
      </button>
      <div id="walletInfo" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
        <p class="text-sm font-medium">Wallet: <span id="walletAddress" class="font-mono text-xs break-all"></span></p>
        <p class="text-sm font-medium mt-2">Health Factor: <span id="healthFactor" class="font-bold text-green-600">N/A</span></p>
        <p class="text-sm font-medium mt-2">Collateral Value: <span id="collateralValue" class="font-bold">N/A</span></p>
        <p class="text-sm font-medium mt-2">Borrowed Value: <span id="borrowValue" class="font-bold">N/A</span></p>
      </div>
      <p id="errorMessage" class="hidden text-red-500 text-sm mt-2"></p>
    </section>
    <!-- Health Trend Chart -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-lg font-semibold mb-4">Health Factor Trend</h2>
      <canvas id="healthChart"></canvas>
    </section>
    <!-- Settings Form -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h2 class="text-lg font-semibold mb-4">Notification Settings</h2>
      <form id="settingsForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Alert Threshold (Health Factor)</label>
          <input type="number" step="0.1" value="1.1" id="threshold" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <p class="text-xs text-gray-500 mt-1">Notify when health factor falls below this value (e.g., 1.1).</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Notification Email</label>
          <input type="email" id="email" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@email.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Phone Number (for SMS)</label>
          <input type="tel" id="phone" class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+12345678900">
          <p class="text-xs text-gray-500 mt-1">Enter phone number in international format (e.g., +12345678900).</p>
        </div>
        <button type="submit" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition duration-300">
          Start Monitoring
        </button>
      </form>
    </section>
    <!-- Notification History -->
    <section class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-lg font-semibold mb-4">Notification History</h2>
      <ul id="notificationHistory" class="space-y-2"></ul>
    </section>
  </main>
  <script>
    // Sepolia network configuration
    const SEPOLIA_CHAIN_ID = "0xaa36a7";
    const SEPOLIA_CONFIG = {
      chainId: SEPOLIA_CHAIN_ID,
      chainName: "Sepolia",
      nativeCurrency: { name: "Sepolia ETH", symbol: "ETH", decimals: 18 },
      rpcUrls: ["[invalid url, do not cite]
      blockExplorerUrls: ["[invalid url, do not cite]
    };

    let provider;
    let compound;
    async function initializeWeb3() {
      if (!window.ethereum) {
        document.getElementById("errorMessage").classList.remove("hidden");
        document.getElementById("errorMessage").textContent = "MetaMask is not installed. Please install MetaMask and try again.";
        console.error("MetaMask not detected.");
        return false;
      }

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        console.log("Provider initialized:", provider);

        // Check current network
        const { chainId } = await provider.getNetwork();
        console.log("Current chain ID:", chainId.toString(16));

        if (chainId.toString(16) !== SEPOLIA_CHAIN_ID.replace("0x", "")) {
          console.log("Attempting to switch to Sepolia...");
          try {
            await provider.send("wallet_switchEthereumChain", [{ chainId: SEPOLIA_CHAIN_ID }]);
            console.log("Switched to Sepolia.");
          } catch (switchError) {
            if (switchError.code === 4902) {
              console.log("Sepolia not found in MetaMask. Adding network...");
              await provider.send("wallet_addEthereumChain", [SEPOLIA_CONFIG]);
              console.log("Sepolia added.");
            } else {
              throw switchError;
            }
          }
        } else {
          console.log("Already on Sepolia network.");
        }

        // Check if Compound.js is loaded
        if (typeof window.Compound !== 'function') {
          throw new Error("Compound.js is not loaded or not a constructor. Ensure the script is included and loaded correctly.");
        }
        compound = new window.Compound(provider, { network: 'sepolia' });
        console.log("Compound.js initialized.");
        return true;
      } catch (error) {
        console.error("Error initializing Web3:", error);
        document.getElementById("errorMessage").classList.remove("hidden");
        document.getElementById("errorMessage").textContent = `Failed to initialize Web3: ${error.message}. Please check MetaMask settings and ensure Compound.js is loaded.`;
        return false;
      }
    }

    // Chart.js setup
    let healthChart;
    const healthData = { labels: [], datasets: [{ label: "Health Factor", data: [], borderColor: "rgb(75, 192, 192)", tension: 0.1 }] };
    function initChart() {
      const ctx = document.getElementById("healthChart").getContext("2d");
      healthChart = new Chart(ctx, {
        type: "line",
        data: healthData,
        options: { scales: { y: { beginAtZero: false } } }
      });
    }
    initChart();

    // Connect to MetaMask
    async function connectWallet() {
      const initialized = await initializeWeb3();
      if (!initialized) return;

      try {
        await provider.send("eth_requestAccounts", []);
        const signer = provider.getSigner();
        const address = await signer.getAddress();
        console.log("Connected wallet:", address);
        document.getElementById("walletAddress").textContent = address;
        document.getElementById("walletInfo").classList.remove("hidden");
        document.getElementById("errorMessage").classList.add("hidden");
        await updateDashboard(address);
        fetchNotificationHistory(address);
      } catch (error) {
        console.error("Error connecting wallet:", error);
        document.getElementById("errorMessage").classList.remove("hidden");
        document.getElementById("errorMessage").textContent = error.message.includes("user rejected") 
          ? "Connection rejected. Please approve the connection in MetaMask."
          : `Failed to connect wallet: ${error.message}`;
      }
    }

    // Update dashboard with health and balances
    async function updateDashboard(address) {
      try {
        const liquidityData = await compound.comptroller.getAccountLiquidity(address);
        const healthFactor = liquidityData.liquidity > 0 
          ? (liquidityData.liquidity / (liquidityData.liquidity + liquidityData.shortfall)).toFixed(2) 
          : "0.00";
        document.getElementById("healthFactor").textContent = healthFactor;

        // Update chart
        const now = new Date().toLocaleTimeString();
        healthData.labels.push(now);
        healthData.datasets[0].data.push(parseFloat(healthFactor));
        if (healthData.labels.length > 10) {
          healthData.labels.shift();
          healthData.datasets[0].data.shift();
        }
        healthChart.update();

        // Fetch collateral and borrow balances
        const assetsIn = await compound.comptroller.getAssetsIn(address);
        let totalCollateral = 0;
        let totalBorrowed = 0;
        for (const cTokenAddress of assetsIn) {
          const balanceUnderlying = await compound.cToken.balanceOfUnderlying(address, cTokenAddress);
          const borrowBalance = await compound.cToken.borrowBalanceCurrent(address, cTokenAddress);
          totalCollateral += Number(ethers.utils.formatUnits(balanceUnderlying, 18));
          totalBorrowed += Number(ethers.utils.formatUnits(borrowBalance, 18));
        }
        document.getElementById("collateralValue").textContent = `$${totalCollateral.toFixed(2)}`;
        document.getElementById("borrowValue").textContent = `$${totalBorrowed.toFixed(2)}`;
      } catch (error) {
        console.error("Error updating dashboard:", error);
        document.getElementById("healthFactor").textContent = "Error";
        document.getElementById("errorMessage").classList.remove("hidden");
        document.getElementById("errorMessage").textContent = "Failed to fetch Compound data. Please try again.";
      }
    }

    // Fetch notification history
    async function fetchNotificationHistory(address) {
      try {
        const response = await fetch(`[invalid url, do not cite]);
        const notifications = await response.json();
        const historyList = document.getElementById("notificationHistory");
        historyList.innerHTML = "";
        notifications.forEach(notification => {
          const li = document.createElement("li");
          li.className = "text-sm text-gray-700 p-2 bg-gray-50 rounded";
          li.textContent = `${new Date(notification.timestamp).toLocaleString()}: ${notification.message}`;
          historyList.appendChild(li);
        });
      } catch (error) {
        console.error("Error fetching notifications:", error);
        document.getElementById("errorMessage").classList.remove("hidden");
        document.getElementById("errorMessage").textContent = "Failed to fetch notification history.";
      }
    }

    // Handle wallet connection
    document.getElementById("connectWallet").addEventListener("click", connectWallet);

    // Handle settings form
    document.getElementById("settingsForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const threshold = parseFloat(document.getElementById("threshold").value);
      const email = document.getElementById("email").value;
      const phone = document.getElementById("phone").value;
      const address = document.getElementById("walletAddress").textContent;

      if (!address) {
        document.getElementById("errorMessage").classList.remove("hidden");
        document.getElementById("errorMessage").textContent = "Please connect your wallet first!";
        return;
      }

      try {
        const response = await fetch("[invalid url, do not cite] {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address, threshold, email, phone })
        });
        if (response.ok) {
          Push.create("Monitoring Started!", {
            body: `We'll notify you if your health factor falls below ${threshold}.`,
            timeout: 4000
          });
          document.getElementById("errorMessage").classList.add("hidden");
        } else {
          throw new Error("Failed to save settings.");
        }
      } catch (error) {
        console.error("Error saving settings:", error);
        document.getElementById("errorMessage").classList.remove("hidden");
        document.getElementById("errorMessage").textContent = "Error connecting to backend. Please try again.";
      }
    });

    // Request push notification permission
    Push.Permission.request();
  </script>
</body>
</html>